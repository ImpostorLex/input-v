---
{"dg-publish":true,"permalink":"/cards/active-directory/kerberos/","tags":["sunday"]}
---

[[cards/active-directory/Active Directory\|Active Directory]]
### Introduction 
---
The default authentication method of Microsoft Window's Active Directory that is much more secure than NTLM authentication protocol.

The main goal is to have a mechanism to authenticate user without actually sending exposed clear text passords and sensitive data bata over the wire.
## Core Components

The three heads of Kerberos:

- _realms_ - logically grouping resources and identities that requires kerberos authentication and authorization mechanism.

1. **Principal** - the entity that wishes to authenticate - it can be either:
	- **User Principal** - `Orpheus@UNDERWORLD.CORP` where Orpheus is the user in the _realm_ `UNDERWORLD.corp`.
	- **Service Principal** - common services such as HTTP server or a file share. Consider: `HTTP/hadesshares.underworld.internal@UNDERWORLD.CORP` where 'HTTP' serves as the id for the http service, ''hadesshares.underworld.com' indicates the FQDN of the web server and the realm 'UNDERWORLD.CORP'.
2. **Resources** - a resource such as an asset or service that the clients aims to reach.
3. **Key Distrubution Center** - Central component of kerberos responsible for managing authentication and distributing session keys in a realm.
## Key Distribution Center (KDC)

![Kerberos.png](/img/user/cards/active-directory/images/Kerberos.png)

Important components of KDC:

1. **Kerberos database** - This stores the necessary authentication information regarding the principal and the systems and services they can authenticate to.
2. **Authentication Service** - Principals use this service to authenticate themselves to get a **ticket-granting-ticker (TGT)**.
3. **Ticket Granting Services (TGS)** - The service accepts the TGT so the client can access the requested resource.
#### Kerberos Tickets
---
- Leverage asymmetric encryption, two encryption keys:
	- **The ticket key**: Shared between the Kerberos infrastructure and the service requested by the principal.
	- **The session key**: Shared between the principal and the service requested. Used to encrypt and decrypt communication with the service
### Kerberos Authentication Process
---
> Orpheus wants to connect to Hades file server to check secret information about the whereabouts of Eurydice. If Hades’ realm of the dead were a Kerberos Realm, this would be the flow for client authentication:

Before the user can access the requested system, it performs pre-authentication first.
#### Pre-Authentication (AS-REQ)
---
- _client's long term secret key_ - a hashed secret key generated by the Kerberos authentication server.

1. User encrypts a timestamp using it's _client's long term secret key_ proving that he/she knows the password then sends it to Authentication Server.
2. Authentication Server validates the credentials by looking up the password hash of the user (Orpheus) and attempts to decrypt the timestamp using the hash from the user.
	- If the decryption is succesful and timestamp is unique, the AS authenticates the user.
3. User receives a AS-REPly from the AS that contains:
	- encrypted Ticket Granting Ticket (TGT).
	- Session key, encrypted with the user's hash.
##### Succesful authentication now requesting for authorization
---
Remember KGC is made up of Ticket Granting Server and Authentication Server.

1. The user (Orpheus) sends a TGS-REQ to the **Ticket Granting Server (TGS)** containing:
	- User name and timestamp encrypted with the session key.
	- Name of the resource he’s trying to access (file server with secret information about the whereabouts of Eurydice).
	- The encrypted TGT he received upon authentication.
2. The Ticket Granting Service on the KDC verifies if the resource exist, decrypts the TGT and extract session keys from the TGT.
3. TGS responds with Ticket Granting Server Reply (TGS-REP)
	- Name of the service which access has been granted.
	- Session key for user and the file server.
	- Service Ticket
##### Session Key and Service Ticket = Access Granted
----
1. User (Orpheus) sends a Application Request (AP-REQ) to the application server with:
	- Service Ticket
		- This includes the Privileged Attribute Certificate (PAC) that contains information about the authenticating user and their privileges.
	- Username and timestamp encrypted with the session key.
2. Service Ticket is decrypted with the app server's secret key (this is shared with the TGS)
3. Application Server verifies if the **AP-REQ** username matches the decrypted one from the Service Ticket.
4. Application Server Reply AP-REP granting access to the requested resource (assuming user have permission).
5. The service grants access including sending a session key to establish a secure session included in the **AP-REP**.

### Questions and Problems
---
- Look into this: https://www.hackthebox.com/blog/active-directory-hardening-pentester-vs-soc
## Conclusion
---

https://activedirectorypro.com/what-is-active-directory/
https://www.hackthebox.com/blog/what-is-kerberos-authentication