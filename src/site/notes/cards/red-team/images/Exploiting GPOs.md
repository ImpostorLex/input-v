---
{"dg-publish":true,"permalink":"/cards/red-team/images/exploiting-gp-os/"}
---

~ [[cards/red-team/Exploiting Active Directory\|Exploiting Active Directory]]
## Summary
---
**What it is:** 

Exploiting GenericWrite permissions on a Group Policy Object (GPO) to add a controlled AD account to local Administrator and Remote Desktop Users groups on domain-joined machines. 

**Scope:** This note covers GPO abuse via GenericWrite permissions to escalate privileges and gain persistence on targeted machines within an OU. 

**Prerequisites:**

- [[cards/active-directory/Group Policy Objects\|Group Policy Objects]] (Parent note) 
- [[Active Directory Permissions\|Active Directory Permissions]] 
- Valid domain credentials with GenericWrite on target GPO
- Network access to domain controller (SYSVOL share) 
- RDP or alternative access to domain-joined workstation 

**Risks & Limitations:** 
- Changes apply during next Group Policy refresh (default: 15 minutes) 
- Modifications are logged in Group Policy event logs 
- Requires legitimate account with specific permissions 
- GPO changes affect ALL machines in linked OU 

**Key Topics:** [[cards/active-directory/Group Policy Objects\|Group Policy Objects]]

## How it works (2–4 lines)

Group Policy Objects define configuration settings for domain-joined machines, stored in SYSVOL and replicated automatically. Administrators use GPOs to manage local group memberships, security settings, and system configurations across many machines. Attackers with `GenericWrite` permissions over a GPO can modify Restricted Groups settings to add their account to privileged local groups, granting administrative access when machines pull the updated policy (default every 15 minutes via gpupdate).

Read [[cards/active-directory/Group Policy Objects\|Group Policy Objects]]
## Steps (Hands-On)
---
**Legend:** 

- {COMPROMISED_USER} = svcServMan / Sup3rStr0ngPass!@

- {TARGET_GPO} = MANAGEMENT SERVER PUSHES@ZA.TRYHACKME.LOC 

- {TARGET_OU} = MANAGEMENT SERVERS@ZA.TRYHACKME.LOC 

- {TARGET_MACHINE} = THMSERVER2.ZA.TRYHACKME.LOC 

- {DOMAIN} = za.tryhackme.loc 

- {WORKSTATION} = THMWRK1 

- {ATTACKER_GROUP} = IT Support


**Context:** You have compromised account `svcServMan` which has **GenericWrite** permissions over the GPO named `MANAGEMENT SERVER PUSHES@ZA.TRYHACKME.LOC`. This GPO is **GpLink'ed** to the Organizational Unit (OU) `MANAGEMENT SERVERS@ZA.TRYHACKME.LOC`, which contains the computer `THMSERVER2.ZA.TRYHACKME.LOC`. Any changes made to this GPO will apply directly to THMSERVER2.

- Bit of a context the `lauren` is not by default a member of the IT support group - do this [[cards/red-team/Exploiting Permission Delegation\|Exploiting Permission Delegation]].

![cards/red-team/images/Exploiting GPOs.png|600](/img/user/cards/red-team/images/Exploiting%20GPOs.png)
### 1. Verify GPO Permissions and Attack Path
---
**Action:**

- Use BloodHound to confirm the attack path: {COMPROMISED_USER} → GenericWrite → {TARGET_GPO} → GpLink → {TARGET_OU} → Contains → {TARGET_MACHINE}
- Document the complete chain and identify all machines in the target OU

![Exploiting GPOs-1.png](/img/user/cards/red-team/images/Exploiting%20GPOs-1.png)

**Observable:**

- BloodHound GUI activity showing the attack path visualization
- LDAP queries to Domain Controller on port 389/636 (if using PowerView/SharpHound for collection)
- Connection to `\\{DOMAIN}\SYSVOL` share for verification

### 2. Establish Access to Group Policy Management Console
---
**Action:** svcServMan / Sup3rStr0ngPass!@

- RDP to a domain-joined workstation (e.g., `THMWRK1`) using your normal Tier 2 Admin account (avoid RDP'ing directly as the compromised user to prevent kicking them out of active sessions)
- Inject {COMPROMISED_USER} credentials into memory using `runas`:

```C
 runas /netonly /user:za.tryhackme.loc\{COMPROMISED_USER} cmd.exe
```

- Provide the password when prompted
- Verify SYSVOL access in the new command prompt:

```C
dir \\{DOMAIN}\SYSVOL
```
    
- Launch MMC console:
    
```
 mmc
```
    

**Observable:**

- RDP connection (Event ID 4624, Logon Type 10) to {WORKSTATION} from your legitimate account
- `runas.exe` process spawning `cmd.exe` with `/netonly` flag
- Outbound SMB connection to Domain Controller on port 445 (SYSVOL access verification)
- `mmc.exe` process launch from the spawned command prompt

### 3. Load Group Policy Management Snap-in
---
**Action:**

- In MMC: **File** → **Add/Remove Snap-in**
- Select **Group Policy Management** snap-in → **Add** → **OK**
- The console should now reveal all GPOs for your domain

![Exploiting GPOs-2.png](/img/user/cards/red-team/images/Exploiting%20GPOs-2.png)

- Navigate to the target GPO path: **Servers** → **Management Servers** → **Management Server Pushes**

![Exploiting GPOs-3.png](/img/user/cards/red-team/images/Exploiting%20GPOs-3.png)

**Observable:**

- MMC snap-in loading activity
- LDAP queries to DC retrieving GPO metadata and organizational structure
- Registry reads under `HKLM\Software\Microsoft\Windows\CurrentVersion\Group Policy`

### 4. Edit Target GPO - Access Group Policy Editor
---
**Action:**

- Right-click on {TARGET_GPO} (e.g., "Management Server Pushes") → **Edit**
- This opens the Group Policy Management Editor window

![Exploiting GPOs-4.png](/img/user/cards/red-team/images/Exploiting%20GPOs-4.png)

**Observable:**

- New Group Policy Management Editor window process (`gpme.msc` or embedded `mmc.exe` with GPO editor snap-in)
- SMB reads from `\\{DOMAIN}\SYSVOL\{DOMAIN}\Policies\{GPO_GUID}\` directory
- LDAP queries fetching GPO settings and configuration

### 5. Add Restricted Groups Policy
---
**Action:**

- Expand **Computer Configuration** → **Policies** → **Windows Settings** → **Security Settings**
- Right-click on **Restricted Groups** → **Add Group**
    - _(Note: If the group already exists, it means someone has performed the exploit previously. You can delete it to recreate or inspect the existing configuration.)_
- Click **Browse**, enter **IT Support** (or {ATTACKER_GROUP}) → **Check Names** → **OK** twice

![Exploiting GPOs-5.png|250](/img/user/cards/red-team/images/Exploiting%20GPOs-5.png)

**Observable:**

- File creation/modification in `\\{DOMAIN}\SYSVOL\{DOMAIN}\Policies\{GPO_GUID}\Machine\Microsoft\Windows NT\SecEdit\GptTmpl.inf`
- Version increment in `\\{DOMAIN}\SYSVOL\{DOMAIN}\Policies\{GPO_GUID}\GPT.INI`
- Active Directory object modification logs (Event ID 5136) if detailed AD auditing is enabled
- SYSVOL replication traffic if multiple DCs exist

### 6. Configure Group Membership Settings
---
**Action:**

- In the Restricted Groups configuration window:
    - Leave **"Members of this group"** field empty (first filter not used)
    - In **"This group is a member of"** field → **Add**:
        - **Administrators**
        - **Remote Desktop Users**
- Final configuration should look like this:

![Exploiting GPOs-6.png|250](/img/user/cards/red-team/images/Exploiting%20GPOs-6.png)

- Click **OK** to save

This group policy applies to the path `za.tryhackme.loc/Servers/Management Servers` , as specified in the GPO path.

![Exploiting GPOs-12.png](/img/user/cards/red-team/images/Exploiting%20GPOs-12.png)

If we add the `Active Directory Users and Computers` snap-in to our `mmc.exe` session, we can inspect that OU.

![Exploiting GPOs-13.png](/img/user/cards/red-team/images/Exploiting%20GPOs-13.png)

![Exploiting GPOs-14.png](/img/user/cards/red-team/images/Exploiting%20GPOs-14.png)

If there were more servers in this OU, this GPO would allow us to RDP as administrators to all of them.

**Observable:**

- Additional writes to `GptTmpl.inf` file with `[Group Membership]` section containing:
    
```C
*S-1-5-32-544__Memberof = {ATTACKER_GROUP_SID}*S-1-5-32-555__Memberof = {ATTACKER_GROUP_SID}
```
    
- GPO version numbers incremented in `GPT.INI` (both User and Computer version counters)
- File modification timestamps updated in SYSVOL
### 7. Wait for or Force Group Policy Update
---
**Action:**

- Wait for automatic Group Policy refresh on {TARGET_MACHINE} (default: 15 minutes)
- **OR** force immediate update on {TARGET_MACHINE}:

```C
gpupdate /force
```

**Observable:**

- On target machine: `gpupdate.exe` process execution
- SMB connections from {TARGET_MACHINE} to DC's SYSVOL share
- Event ID 1502 (Group Policy application success) in System log
- Event ID 4732 (Member added to security-enabled local group) - {ATTACKER_GROUP} added to Administrators
- Event ID 4744 (Member added to security-enabled local group) - {ATTACKER_GROUP} added to Remote Desktop Users
- Local group membership changes visible via `net localgroup administrators` and `net localgroup "Remote Desktop Users"`

### 8. Verify Access and Lateral Movement
---
**Action:**

- Verify {ATTACKER_GROUP} membership in local privileged groups on {TARGET_MACHINE}:
    
```
net localgroup administrators
net localgroup "Remote Desktop Users"
```
    
- Establish administrative access to {TARGET_MACHINE} using {COMPROMISED_USER} via:
    - RDP: `mstsc /v:{TARGET_MACHINE}`
	    - **(In this case) The user must be in the IT support group.**
    - SMBExec, PSExec, or other lateral movement techniques

Although when executing `whoami` - it will still show your old user but it will now have access to the Administrator group:

![Exploiting GPOs-15.png](/img/user/cards/red-team/images/Exploiting%20GPOs-15.png)


**Observable:**

- New authentication event (Event ID 4624) on {TARGET_MACHINE}:
    - Logon Type 10 (RDP) or Logon Type 3 (Network) for SMBExec/PSExec
    - Account: {COMPROMISED_USER}
    - Source: {WORKSTATION} or attacker machine
- Elevated token usage (member of Administrators group)
- Administrative actions performed by {COMPROMISED_USER} on {TARGET_MACHINE}

