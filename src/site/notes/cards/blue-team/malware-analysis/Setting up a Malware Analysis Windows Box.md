---
{"dg-publish":true,"permalink":"/cards/blue-team/malware-analysis/setting-up-a-malware-analysis-windows-box/","tags":["malware"]}
---

[[atlas/malware\|malware]] 
### Introduction 
---
Windows by far is the most used operating system today even though it is bloated and comes with privacy issues another issue that also comes with is that most malwares are made for Windows.

## Prerequisites
---
- Fresh install of Windows 10 in VirtualBox or  VmWare - [guide here](https://www.extremetech.com/computing/how-to-install-windows-11-in-a-virtual-machine)
## Step 1 - Baselining
---
1. Take a snapshot 
2. Replace built-in terminal with CMDER or Windows Terminal
3. Disable proxy setting (Automatically detect settings)
4. Disable Virus and Threat Protection
5. Disable Windows Defender
	1. Edit Group Policy
	2. Computer Configuration -> Administrative Templates
	3. Windows Component -> Microsoft Defender Antivirus
	4. Network -> Network Connections
	5. Windows Defender Firewall
	6. Disable Protect All Network Connection for both Standard and Domain Profile
6. Take a snapshot

## Step 2 - FlareVM installation
---
Run the following code in PowerShell Admin Prompt:

```Powershell
(New-Object net.webclient).DownloadFile('<REPLACE_ME>',"$([Environment]::GetFolderPath("Desktop"))\install.ps1")
```

Replace the `REPLACE_ME` with the url below:

```C
https://raw.githubusercontent.com/mandiant/flare-vm/main/install.ps1
```

- Change directories to the Desktop
- Run: `Unblock-File .\install.ps1`
- Run: `Set-ExecutionPolicy Unrestricted`
- Accept the prompt to set the ExecPol to unrestricted if one appears

Run the below code to get all the tools

```Powershell
.\install.ps1 -customConfig https://raw.githubusercontent.com/HuskyHacks/PMAT-labs/main/config.xml
```

Say yes to the prompts and there will be a GUI that will show all the tools that will be installed, the default is OK

A log.txt and an old Windows 3 sound will indicate that the installation is successful.

Than take a snapshot - this is the most important step everytime we detonate a malware.

## Step 3 - Analysis Network Setup
---
In virtual box - create a new network

![Pasted image 20240512113245.png](/img/user/cards/blue-team/malware-analysis/images/Pasted%20image%2020240512113245.png)

The important thing is to create a network that is different from our host IP address and edit the DHCP server as well.


![Pasted image 20240512113323.png](/img/user/cards/blue-team/malware-analysis/images/Pasted%20image%2020240512113323.png)

Change the network setting of the VM, this includes the REMNUX and ensure that other adapter is not enabled.

![Pasted image 20240512115540.png](/img/user/cards/blue-team/malware-analysis/images/Pasted%20image%2020240512115540.png)

- Ping `8.8.8.8` and `google.com` make sure it is unreachable
- Ping each other make sure it is reachable.

## Step 4 - Remnux as Internet Simulator 
---
Some Malware are designed to grab something from the Internet and do some malicious stuff with it but our network is isolated, thankfully Remnux has the capabilities of pretending as Internet.

```bash
sudo vim /etc/inetsim/inetsim.conf
```

Uncomment the following lines from the file:

```
start_service_dns

service_bind_address 0.0.0.0
```

This enables the DNS for name resolution since most malware will use domain name and `service_bind_address 0.0.0.0` instructs the service to accept connections from any IP address that reaches the machine on any network interface.

```
dns_default_ip <remnux_ip> 
```

Specify a default DNS server IP address that a system or application should use when resolving domain names if no other DNS server is explicitly configured or available.

Then at the Windows machine:

![Pasted image 20240512155908.png|350](/img/user/cards/blue-team/malware-analysis/images/Pasted%20image%2020240512155908.png)

Run:

```
inetsim
```

### Remnux and FlareVM
---
One of the capabilities of Remnux is to pretend to acts as a Internet simulator, this is great if a malware is designed to grab something from the Internet but in our case Remnux will download a fake (safe) `.exe` and if a malware wants to go to `malicious.com` it will display a fake (safe) Remnux static page.

![Pasted image 20240512155119.png](/img/user/cards/blue-team/malware-analysis/images/Pasted%20image%2020240512155119.png)

### Concerns using Host-Only Adapter
---
In this setup - VM to Host and vice versa, communications is possible:

Setup `NCAT` with FlareVM:

```
C:\Users\husky>ncat -nvlp 80
Ncat: Version 5.59BETA1 ( http://nmap.org/ncat )
Ncat: Listening on 0.0.0.0:80
```

Connect to `NCAT` with Physical Host
```
PS C:\Users\Matt> ncat -nv 10.0.0.4 80
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Connected to 10.0.0.4:80.
hello!
```

This works with default firewall configuration, but if we do this on reverse and have our physical host act as a `ncat` server it won't work as the **host firewall** will prevent this from occuring.

If we imagine any malware sample that detonates in FLAREVM and tries to traverse out to our physical host, this traffic will now either:

- be handled and routed to INetSim,
- or, be dropped by the physical hostâ€™s firewall.

As for **unix** and **MacOS** physical host, you can use the `iptables` utility feature to drop traffic that is inbound from the guest VMs.

```bash
iptables -A INPUT -s [IP ADDRESS] -j DROP
```

This is only necessary if we are planning on executing malware that is designed for nix.
### Why not Internal Network?
---
You can however there will be a lot of configurations to do.
### Detonating a Sample 
---

Detonating Wannacry.exe:

![Pasted image 20240516150201.png](/img/user/cards/blue-team/malware-analysis/images/Pasted%20image%2020240516150201.png)

I have no idea how to beat this thing yet, fortunately I saved a snapshot before detonation.

## Conclusion 
---
A malware analysis box should be always isolated using [[cards/networking/Virtualization Networking#Host-Only\|host only adapter]] or [[cards/networking/Virtualization Networking#Intnet\|internal network]] from the physical host network and in order to simulate malware using the Internet for it's malicious purposes, we setup Remnux that comes with inetsim that will pretend as the Internet.



