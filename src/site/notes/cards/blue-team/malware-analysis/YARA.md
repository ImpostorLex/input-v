---
{"dg-publish":true,"permalink":"/cards/blue-team/malware-analysis/yara/","tags":["malware"]}
---

[[map-of-contents/malware\|malware]] 
### Introduction 
---
Is a pattern matching based on binary and textual patterns such as **hexadecimal** and **strings** to identify a malware.

It uses what they call **rules** to determine if a file is malicious or not and one of the key component of that is the `strings` that every application uses to store data.
## Prerequisites
---
- Yara installed
- Text Editor prefferably with YARA syntax highlighting
- Great reference to [[cards/blue-team/threat-intelligence/Pyramid of Pain\|Pyramid of Pain]].
## Rules
---
The `yara` command requires two argument:

1. The rule file we create
2. Name of the file, directory, or process ID to use the rule for.

> [!example]+ Example
> `yara myrule.yar somedirectory`
> or
> `yara32`  or `yara64` for Windows FlareVM

- `-s` to find out which condition is triggered and their memory location.
- `-r` recurse, recommended with administrator level. turns yara into a threat hunting tool.

if exists or conditions matches:

![Pasted image 20240704143459.png](/img/user/cards/blue-team/malware-analysis/images/Pasted%20image%2020240704143459.png)

else (or in some version no error or info is shown):

![Pasted image 20240704143510.png](/img/user/cards/blue-team/malware-analysis/images/Pasted%20image%2020240704143510.png)

View the string or pattern:

```C
hexdump -C samples.exe | grep "Hello World"
```

## Conditions
---
### Meta
Work similarly to `comments` in programming languages, such as commenting what your `rule` does, using a key-value pair format:

```C
meta:
	last_upaded = "2020-10-15"
	amazing = "LMAO"
// This is a actual comment but not interactable unlike the above.
```

- Ideally include (if possible): `hash` sha256 of the malware, `description`, `reference` of information and `tags`.

### Strings
We can use `strings` to search for a specific text or hexadecimals in files or programs:

```C
rule helloworld_checker {
	strings:
		$hello_world = "Hello World!"

	condition:
		$hello_world
}
```

What the above does is we defined the `strings` keyword and stores the `Hello World!` inside a variable name `hello_world`.

But the problem is it won't check for `hello world`, `HELLO WORLD` to solve this we can use `any of them`:

```C
rule helloworld_checker{
	strings:
	    // Tells YARA if you detect this string as ASCII that is a criteria
		$hello_world = "Hello World!" ascii
		$hello_world_lowercase = "hello world"
		$hello_world_uppercase = "HELLO WORLD"

	condition:
		any of them
}
```

### Conditions
---
Works like any othe programming languages:
**<=** less than or equal to
**>=** more than or equal to
**!=** not equal to

```C
rule helloworld_checker{
	strings:
		$hello_world = "Hello World!"

	condition:
        #hello_world <= 10
}
```

This will check for `Hello World!` that occurs less than ten times.
### With Keywords
**and**
**not**
**or**

This checks for `Hello World!` and if file size is less than 10kb.

```C
rule helloworld_checker{
	strings:
		$hello_world = "Hello World!" 
        
        condition:
	        $hello_world and filesize < 10KB 
}
```

### Additional Examples
---
```C
strings:
	$sus_hex_string = { FF E4 ?? 00 FF }
	// MZ is magic byte it is a sign of Portable Executable
	$PE_magic_byte = "MZ"
```

It is a set of bytes to look for and the `??` is a wildcard and for the condition:

```C
condition:
	$PE_magic_bye at 0 and
	($string1 and string2)
```

The condition basically looks for the 'MZ' **and** `$string1` _and_ `$string2` if either conditions are not found then there is no alert.

**or**  instead of the above condition:

```C
import "pe"

rule .... {
....
condition:
	pe.is_pe at 0 and // is portable executable
	($string1 and $string2)
}
```

Cheatsheet:
![Pasted image 20240704143809.png|450](/img/user/cards/blue-team/malware-analysis/images/Pasted%20image%2020240704143809.png)

Link for other conditons [here](https://yara.readthedocs.io/en/stable/writingrules.html).
### Modules
---
It can also be integrated with third party applications such as _Cuckoo Sandbox_ and _Python's PE module_.
## Conclusion
---
In this tutorial, we learned about YARA a powerful rule based tool that can be integrated with third party application not only it's powerful it is easy to use as well - it requires a little bit of programming knowledge and you are good to go.
