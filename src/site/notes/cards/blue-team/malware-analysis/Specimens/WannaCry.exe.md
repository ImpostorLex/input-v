---
{"dg-publish":true,"permalink":"/cards/blue-team/malware-analysis/specimens/wanna-cry-exe/","tags":["specimen"]}
---

[[atlas/malware\|malware]] 
### Introduction 
---
It appeared on the year 2017, it exploits the Server Message Block protocol on Windows system, the exploit was developed by the National Security Agency and named as EternalBlue - it appends a `.wncry` extensions to specific files after encrypting.

Initial detonation:

![[Pasted image 20240704194145.png\|Pasted image 20240704194145.png]]

24d004a104d4d54034dbcffc2a4b19a11f39008a575aa614ea04703480b1022c
## Static Analysis
---
### VirusTotal Score with sha256sum
---
Getting sha256sum of the malware, it's VirusTotal score is 72/74
### Strings and Import Address Table
---
- InternetOpenUrlA - Parse a URL string and downloads a file
- InternetOpenA
- GetProcAddress - Get the memory address of a function in a `.dll` file.
- http[:]//www[.]iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com
- SMB
- StartServiceA
- Cryptography libraries
- OpenServiceA - use to open existing service
- File manipulation functions
- Written in C++ - based on the analysis of PEstudio
- Socket, recv, send.
- The (`\\192.168.56.20\IPC$`, `\\192.168.56.20\IPC$`)
- .wnry binaries

![[Pasted image 20240628194448.png\|350]]

![[Pasted image 20240628203818.png\|Pasted image 20240628203818.png]]

~~And it does not seem to be a packed binary.~~

In the stings the "This program cannot be executed in DOS mode" is found multiple times - it is possible that it is a packed binary basically a executable that contains an executable and can be confirm on indicators on pestudio.

At this point, my assumption is that it first opens the SMB protocol and tries to exploit it, once succesful it reaches out to the Internet and downloads a file.
#### Analysis with Cutter
---
Looking at the graph view:

![[Pasted image 20240628204200.png\|Pasted image 20240628204200.png]]

We can see that the string 'http....' is `mov` to `esi` then the `xor eax, eax` will automatically result into 0.

```C
HINTERNET InternetOpenA(
  [in] LPCSTR lpszAgent, // 0
  [in] DWORD  dwAccessType, // 1 
  [in] LPCSTR lpszProxy, // 0 
  [in] LPCSTR lpszProxyBypass, // 0 
  [in] DWORD  dwFlags // 0
);
```

Basically the `1` is for "INTERNET_OPEN_TYPE_DIRECT" according to the documentation - resolve all host names locally and the rest are null or empty.

```C
HINTERNET InternetOpenUrlA(
  [in] HINTERNET hInternet, // handle from InternetOpenA
  [in] LPCSTR    lpszUrl, // URL http://.....
  [in] LPCSTR    lpszHeaders, // Empty
  [in] DWORD     dwHeadersLength, // Empty
  [in] DWORD     dwFlags, // 0x84000000 = 2214592512
  [in] DWORD_PTR dwContext // Empty
);
```

- The handle returned from InternetOpenA function
- The value stored on the `esi` which is the URL to be contacted and read
- No headers
- The size of the additonal headers - none

It will return a valid handle to the URL if the connection is succesfully established per the documentation, then it will close the handle and performs a bitwise AND operation **test edi, edi** and the result:

- If the result is zero it means it will jump to the green path
- if the result is non zero then it will jump on the red path

![[Pasted image 20240629225044.png\|Pasted image 20240629225044.png]]

![[Pasted image 20240629212957.png\|Pasted image 20240629212957.png]]

Then it makes a jump if it successfully establishes a connection the program ends and if not the ransomware payload continues:

![[Pasted image 20240628211642.png\|Pasted image 20240628211642.png]]
## Dynamic Analysis
---
The malware made contact to the string that was found earlier:

![[Pasted image 20240629142304.png\|Pasted image 20240629142304.png]]

However no follow up request.

### Questions and Problems
---
#### Record any observed symptoms of infection from initial detonation. What are the main symptoms of a WannaCry infection?
---
- It makes a request to a very long jumbled letters 'www[.]iuqer.....com/' with Internet simulator
- A new binary has spawn name @wannadecryptor@ and a @Please_Read_Me@ text file on the desktop
- A program that keep spawning even closing that provides information that contains BTC address, timer and how much to pay.
- ![[Pasted image 20240629144103.png\|Pasted image 20240629144103.png]]
- s
#### Use FLOSS and extract the strings from the main WannaCry binary. Are there any strings of interest?
---
#### Inspect the import address table for the main WannaCry binary. Are there any notable API imports?
---
#### What conditions are necessary to get this sample to detonate?
---
The malware only works if there is no succesful connection established on the very long jumbled URL, so in order for the rest of the ransomware payload to work - the Inetsim needs to be turned off.
#### Network Indicators: Identify the network indicators of this malware
---
- It tries to establish to the URL found and there determines if a succesful connection establish to the URL the rest of the ransomware payload will not be executed.
- It will try and propagate through SMB ![[Pasted image 20240629222950.png\|Pasted image 20240629222950.png]]
- It opens up `taskhsvc.exe` at port 9050
#### Host-based Indicators: Identify the host-based indicators of this malware. 
---
- Creation of a file name `tasksche.exe` 
- A directory created in at `C:\ProgramData` ![[Pasted image 20240629223536.png\|Pasted image 20240629223536.png]]
- Persistence mechanism is installed with the same name as the directory created at the ProgramData - it can be found on Task Manager -> Services -> `<name>`.



#### Use Cutter to locate the killswitch mechanism in the decompiled code and explain how it functions.
---


## Conclusion
---



https://medium.com/@alexxmacenas/malware-analysis-report-of-wannacry-4e7754137e74