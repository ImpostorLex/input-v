---
{"dg-publish":true,"permalink":"/cards/blue-team/malware-analysis/binary-patching/"}
---

[[map-of-contents/malware\|malware]] 
### Introduction 
---
**Is the process of altering a part of a program to do what we want or reach a certain part of the program to get the whole picture**, sometimes Malware authors puts a condition to check whether the dependencies for the malware is there or not and if not delete itself or do the unwanted part so the blue team will never have the whole picture of what the malware do this technique is known as _Anti-Analysis_.
## Prerequisites
---
- A debugger such as Cutter
- [[cards/blue-team/malware-analysis/Advanced Static Analysis\|Advanced Static Analysis]]
## IsDebuggerPresent() API
---
The most easiest anti-analysis technique to detect and defeat, the APi returns a nonzero value if it is running in a debugger and zero otherwise.

![[Pasted image 20240611205442.png\|Pasted image 20240611205442.png]]

The most interesting bit here is the **test eax, eax** by performing a bitwise `AND` and set the value of Zero Flag to 1 or 0, depending on the outcome.

Then the program performs a **SETNE AL** (**SET** If **N**ot **E**qual To) instruction call, **SETNE AL** sets the value of `AL` (the lower bits of `EAX`) to 1 or 0 depending on the value of the Zero Flag result from **test eax, eax**.

![[Pasted image 20240611210246.png\|Pasted image 20240611210246.png]]

Then the **AL** is tested against itself and the Zero Flag is set to 1 or zero, if the Zero Flag is 1 take the jump to the memory location otherwise do not take the jump.

![[Pasted image 20240611210640.png\|450]]

Defeating the `isDebuggerPresent()`, Right click into the CPU section “Search For → All Modules → String References” then search for it:

Set a breakpoint (F2):
![[Pasted image 20240611211044.png\|Pasted image 20240611211044.png]]

Return and press `F9` until we hit the breakpoint:

![[Pasted image 20240611211341.png\|Pasted image 20240611211341.png]]

Then press `F8` to step through until we return from the call and add a breakpoint to the **test eax, eax**:

![[Pasted image 20240611211443.png\|Pasted image 20240611211443.png]]

When the **RIP** is on the row of **je (jump instruction)** the **Zero Flag** is set to 0 which we don't want, Hit `F8` until you hit the row:

![[Pasted image 20240611211624.png\|Pasted image 20240611211624.png]]

We can simply double click the zero and it will turn into 1 then run the program then `F8` again until:

![[Pasted image 20240611212455.png\|Pasted image 20240611212455.png]]







### Questions and Problems
---
## Conclusion
---

