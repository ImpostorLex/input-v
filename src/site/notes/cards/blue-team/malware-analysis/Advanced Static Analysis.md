---
{"dg-publish":true,"permalink":"/cards/blue-team/malware-analysis/advanced-static-analysis/","tags":["malware"]}
---

[[cards/blue-team/malware-analysis/Advanced Analysis\|Advanced Analysis]]
### Introduction 
---
Since we are performing static analysis we do not need to arm the malware.

You will be using a decompiler/dissassembler name _cutter_ to reverse engineer a program.
## Cutter
---
Select the malware and the default settings is good enough:

![Pasted image 20240527102501.png](/img/user/cards/blue-team/malware-analysis/images/Pasted%20image%2020240527102501.png)

- Disassembly - to read raw code
- Graph - to see the execution flow
- Decompiler - to read the replicated raw code.
- It is a good idea to check the found strings against floss it might give us an idea if the string is hard-coded or programatically being made.
## Prerequisite
---
- [[cards/blue-team/malware-analysis/x86 CPU Instructions, Memory Register & the Stack\|x86 CPU Instructions, Memory Register & the Stack]] 
- [[RAM\|RAM]]
- [[CPU\|CPU]]
## Hello World with C 
---
```C
#include <stdio.h>
int main() {
   printf("Hello, World!");
   return 0;
}

// push ebp: preserving the calling function's base address since the `main` function is actually called by the mainCRTStartup - basically know where to return when main func is done

// mov ebp, esp: moves the value of stack pointer to base pointer

// sub esp, 16(Converted to hexa via cutter feature): Subtract 16 bytes to give space to work with local variables and params from the stack
```

Opening it up with cutter:

![Pasted image 20240604105227.png](/img/user/cards/blue-team/malware-analysis/images/Pasted%20image%2020240604105227.png)

The `dbg` is short for debugger - malware authors use stripping tools to remove this in order to make reverse engineering it hard.

In the **strings** tab, at the bottom we can filter out for "Hello, World!":

![Pasted image 20240604105607.png](/img/user/cards/blue-team/malware-analysis/images/Pasted%20image%2020240604105607.png)
We can also click + `X` key to open up where the "Hello, World!" is located and cutter also shows where or what section it belongs to which is `.data`where all initialized and constant variables are placed.

`Show X-Refs` by right clicking the string to show where it is being used:

![Pasted image 20240604140955.png](/img/user/cards/blue-team/malware-analysis/images/Pasted%20image%2020240604140955.png)
## Finding the main entry point
---
In some cases, malware authors removes the debug symbols to make the analysis hard and to find main function, **we can start at the end of the program and work backwards and find a function that returns a value onto the eax register.**

> Entrypoint -> C RunTime -> Main

By default the entrypoint usually name as **entry0** set up the C runtime and the last thing that occurs at the CRT is the actual main function:

Looking at the bottom of the graph, we can see **eax, dword 0x...**:
![Pasted image 20240617190805.png](/img/user/cards/blue-team/malware-analysis/images/Pasted%20image%2020240617190805.png)

Highlighting the `[0x004...]` and see where it is used or called on the graph:

![Pasted image 20240617191108.png|450](/img/user/cards/blue-team/malware-analysis/images/Pasted%20image%2020240617191108.png)

Now the last **call** is most likely the main function as again in the image there is a value move to the **eax** register then right click the function and just to be efficient we can right click and rename the function to **main**.

## Malware.stage0 dropper
---
Performing full basic analysis first:
### Basic Static Analysis
---
- sha256sum flag as malicious by VirusTotal
- GetCurrentProcessID
- CreateProcess
- OpenProcess
- pestudio under sections - does not seem like it is packed.
### Basic Dynamic Analysis 
---
- WhereFault is actually ask user if a program it will ask to send info to Microsoft i.e "Where Fault"
- In Wireshark after initial detonation, no packet stood out.
- ProcessMonitor found file created at Users Public name werflt.exe spawns a cmd and dissapears immediately and looking at the details it says `werflt.exe <num>`
- Opens up or connect to port 8443 on localhost when running the main program then dissapears quickly![Pasted image 20240604161256.png](/img/user/cards/blue-team/malware-analysis/images/Pasted%20image%2020240604161256.png) 
- Setting up `ncat` and it connects.
### werflt.exe analysis with cutter
---

At the assembly, we see this:
![Pasted image 20240604162137.png](/img/user/cards/blue-team/malware-analysis/images/Pasted%20image%2020240604162137.png)

In the documentation:
![Pasted image 20240604162237.png](/img/user/cards/blue-team/malware-analysis/images/Pasted%20image%2020240604162237.png)

One of the parameters is **dwProcessID** again remember the LIFO. in the above image it will be whatever the value of `push eax` here:

![Pasted image 20240604162738.png](/img/user/cards/blue-team/malware-analysis/images/Pasted%20image%2020240604162738.png)

- There is an argument passed

So whatever the value of `lpStartAddress` it is move into `eax`.

## Resources
---

[[cards/blue-team/malware-analysis/Advanced Dynamic Analysis\|Advanced Dynamic Analysis]] 

[[cards/blue-team/malware-analysis/Specimens/SikoMode - Malware\|SikoMode - Malware]] 