---
{"dg-publish":true,"permalink":"/cards/blue-team/malware-analysis/analyzing-shellcode-malware/","tags":["malware"]}
---

[[map-of-contents/malware\|malware]] 
### Introduction 
---
A shellcode is a piece of small instructions for the CPU to execute specific low level actions directly in memory. Typically written in Assembly.
## Carving Shellcode & scdbg
---
Here is an example:

It is an array of bytes name `rsrc` however to truly understand the program, we need to carve out the bytes specifically remove the `0x` and the `,` and have `scdbg` analyze and build upon it.

![Pasted image 20240615171519.png](/img/user/cards/blue-team/malware-analysis/images/Pasted%20image%2020240615171519.png)

A python script to a `.bin` file:

```python
with open('/tmp/danger.txt', 'r') as file:
    stripped_lines = file.read().replace('byte[] rsrc = new byte[464] {', '').replace('0x', '').replace('};', '').replace(',', '')
    # print(stripped_lines)
    stripped_lines_encoded = stripped_lines.encode()

print(stripped_lines_encoded)
# Write into a .bin file
with open('/tmp/danger.bin', 'wb') as bin_pls:

    bin_pls.write(stripped_lines_encoded)
```

`scdbg` - will interpret the bytes of the shellcode and will resolve API calls and see what the shellcode is actually doing.

```bash
scdbg -f danger.bin -s -1
```

The `-f` flag is for the file in question and as for the `-s -1` is the amount of instructions to resolve `-1` for unlimited:

![Pasted image 20240615175106.png](/img/user/cards/blue-team/malware-analysis/images/Pasted%20image%2020240615175106.png)
## Carving Shellcode in Memory
---
If the shellcode is either hard coded into the binary or usually injected to a process which is only possible by running the binary.

In PEstudio or when performing basic static analysis - this could be seen in the **imports** section:

![Pasted image 20240617171119.png](/img/user/cards/blue-team/malware-analysis/images/Pasted%20image%2020240617171119.png)

The goal in the debugger is to intervene when the APi `WriteProcessMemory` is called.

Here is the main function:

![Pasted image 20240617191433.png|450](/img/user/cards/blue-team/malware-analysis/images/Pasted%20image%2020240617191433.png)

Find the `WriteProcessMemory` and then copy the address, open it up in the debugger: 0x0040170a hitting `CTRL + G` to search:

![Pasted image 20240617191929.png](/img/user/cards/blue-team/malware-analysis/images/Pasted%20image%2020240617191929.png)

We are looking for the `lpBuffer` - this is the actual bad stuff, it points out to a buffer or a region of memory that is used to store data temporarily to be written in the specified process.

![Pasted image 20240617192652.png](/img/user/cards/blue-team/malware-analysis/images/Pasted%20image%2020240617192652.png)

Remember **LIFO**, so it will be the third to be passed down to the function, then we can right click and follow the dump

![Pasted image 20240617192832.png](/img/user/cards/blue-team/malware-analysis/images/Pasted%20image%2020240617192832.png)

Then at the bottom, highlight the actual shellcode:

![Pasted image 20240617193108.png|450](/img/user/cards/blue-team/malware-analysis/images/Pasted%20image%2020240617193108.png)

Then right-click -> Binary -> save to a file with name that ends with `.bin` and open it with scdb:

```
scdbg -f file.bin -s -1
```


![Pasted image 20240617193440.png](/img/user/cards/blue-team/malware-analysis/images/Pasted%20image%2020240617193440.png)


### Questions and Problems
---
## Conclusion
---

